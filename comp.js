function formatDate(e){var t=e.getDate();var n=e.getMonth();var r=e.getFullYear();var i="00";var s=""+t;var o=""+(n+1);var u=""+r;s=i.substring(s.length)+s;o=i.substring(o.length)+o;return s+"."+o+"."+u}function parseDate(e){var t=e.split(".");return new Date(t[2],t[1]-1,t[0])}function newTask(e,t,n){var r=new Object;r.quarterStart=e;r.quarterEnd=t;r.description=n;return r}function subtractMilestone(e,t){for(var n=tasks.length-1;n>=0;n--){var r=tasks[n];if(r.quarterStart!=r.quarterEnd){continue}if(r.quarterEnd!=e&&r.quarterEnd!=t){continue}tasks.splice(n,1)}}function subtractTask(e,t){if(t==e){subtractMilestone(e,t);return}for(var n=tasks.length-1;n>=0;n--){var r=tasks[n];if(r.quarterEnd==r.quarterStart){continue}if(e<r.quarterEnd&&t>=r.quarterStart){if(e<=r.quarterStart){r.quarterStart=t}else if(t>=r.quarterEnd){r.quarterEnd=e}else{var i=newTask(r.quarterStart,e,r.description);var s=newTask(t,r.quarterEnd,r.description);tasks.splice(n,1,i,s)}if(r.quarterEnd<=r.quarterStart){tasks.splice(n,1)}}}}function renderLine(e,t,n,r,i){e.beginPath();e.moveTo(t,n);e.lineTo(r,i);e.stroke()}function visibleWidth(){return box_width-left_column_width-right_column_width}function visibleDays(){return Math.floor((box_height-header_height)/line_height-1)}function visibleDaysHeight(){return visibleDays()*line_height}function dateInQuarters(e){return Math.floor(e.getTime()/1e3/60/15)}function quarterToDate(e){return new Date(e*1e3*60*15)}function quartersStride(){return 24*4}function posToQuarters(e,t){var n=0;if(e>=left_column_width+visibleWidth()){n=(end_hour-start_hour)*4}else if(e<=left_column_width){n=0}else{var r=end_hour-start_hour;n=Math.round(4*(e-left_column_width)*r/visibleWidth())}var i=0;if(t<=header_height){i=0}else if(t>=header_height+visibleDaysHeight()){i=visibleDays()-1}else{i=Math.floor((t-header_height)/line_height)}return dateInQuarters(from_date)+start_hour*4+n+quartersStride()*i}function quarterIntervalToRect(e,t){min=Math.min(e,t);max=Math.max(e,t);var n=quarterIntervalHours(min,max);var r=n[0];var i=n[1];var s=quarterIntervalLines(min,max);var o=s[0];var u=s[1];if(i<r){var a=i;i=r;r=a}if(u<o){var a=u;u=o;o=a}var f=visibleWidth()/(end_hour-start_hour);var l=(r-start_hour)*f+left_column_width;var c=o*line_height+header_height;var h=(i-r)*f;var p=(u-o)*line_height+line_height;return[l,c,h,p]}function quarterIntervalFix(e,t){min=Math.min(e,t);max=Math.max(e,t);var n=quarterIntervalHours(min,max);var r=n[0];var i=n[1];var s=quarterIntervalLines(min,max);var o=s[0];var u=s[1];if(i<r){var a=i;i=r;r=a}if(u<o){var a=u;u=o;o=a}var f=dateInQuarters(from_date);var l=quartersStride();return[f+r*4+o*l,f+i*4+u*l]}function quarterIntervalHours(e,t){var n=dateInQuarters(from_date);var r=e-n;var i=t-n;var s=quartersStride();var o=r%s/4;var u=i%s/4;var a=u>(end_hour-start_hour)*.5||o>(end_hour-start_hour)*.5;if(e==t){var f=r%s/4;if(f==0&&a){return[24,24]}else{return[f,f]}}else{var o=r%s/4;var u=i%s/4;var l=Math.floor(r/s);var c=Math.floor(i/s);if(u==0&&a){return[o,24]}else if(o==0&&a){return[24,u]}else{return[o,u]}}}function quarterIntervalLines(e,t){var n=dateInQuarters(from_date);var r=e-n;var i=t-n;var s=quartersStride();var o=r%s/4;var u=i%s/4;var a=u>(end_hour-start_hour)*.5||o>(end_hour-start_hour)*.5;if(e==t){var f=Math.floor(r/s);var l=r%s/4;if(l==0&&a){return[f-1,f-1]}else{return[f,f]}}else{var c=Math.floor(r/s);var h=Math.floor(i/s);var o=r%s/4;var u=i%s/4;if(u==0&&a){return[c,h-1]}else if(o==0&&a){return[c-1,h]}else{return[c,h]}}}function renderQuarterInterval(e,t,n,r){var i=e==t;var s=quarterIntervalToRect(e,t);if(s==null){return}var o=s[0];var u=s[1];var a=s[0]+s[2];var f=s[1]+s[3];var l=visibleWidth()+left_column_width;var c=visibleDaysHeight()+header_height;o=o<left_column_width?left_column_width:o;u=u<header_height?header_height:u;a=a>l?l:a;f=f>c?c:f;if(a<o)return;if(f<u)return;if(o>a)return;if(u>f)return;if(r){ctx.lineWidth=selected_quarter_line_width;ctx.font=selected_quarter_font;ctx.strokeStyle=selected_quarter_style;ctx.fillStyle=selected_quarter_style}else{ctx.lineWidth=default_quarter_line_width;ctx.font=default_quarter_font;ctx.strokeStyle=default_quarter_style;if(n==""){ctx.fillStyle=default_quarter_background}else{ctx.fillStyle=colors[n.hashCode()%colors.length]}if(!i){ctx.fillRect(o,u,a-o,f-u)}ctx.fillStyle=default_quarter_style}if(i){ctx.save();if(n==""){ctx.fillStyle=default_quarter_background}else{ctx.fillStyle=colors[n.hashCode()%colors.length]}if(r){ctx.strokeStyle=selected_milestone_style}else{ctx.strokeStyle=milestone_style}ctx.beginPath();var h=.2*line_height;var p=o;var d=u+.5*line_height;ctx.moveTo(p,d-h);ctx.lineTo(p+h,d);ctx.lineTo(p,d+h);ctx.lineTo(p-h,d);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();var v=0;if(r){v=1}ctx.fillStyle="black";ctx.fillText(" "+n,o-description_offset+2+v,u+line_height+description_offset-1-v);if(r){ctx.fillStyle=selected_milestone_style}else{ctx.fillStyle=milestone_style}ctx.fillText(" "+n,o-description_offset,u+line_height+description_offset)}else{ctx.strokeRect(o,u,a-o,f-u);if(n!=""){if(r){ctx.fillText(n,o-description_offset,u+line_height+description_offset)}else{ctx.save();ctx.beginPath();ctx.rect(o,u,a-o,f-u);ctx.clip();ctx.fillText(n,o-description_offset,u+line_height+description_offset);ctx.restore()}}}}function stoneSum(e,t,n){if(e.quarterStart>=t.quarterStart){return 0}else if(e.quarterEnd<=t.quarterStart){return(e.quarterEnd-n)/4}else{return(t.quarterStart-n)/4}}function renderTasks(){var e=false;var t=new Object;for(var n=0;n<tasks.length;n++){var r=tasks[n];if(r.quarterStart!=r.quarterEnd){continue}if(r.description==""){continue}r.sum=0;if(t[r.description]==null){t[r.description]=[r]}else{var i=t[r.description];var s=false;for(var o=0;o<i.length;o++){if(r.quarterStart<i[o].quarterStart){i.splice(o,0,r);s=true;break}}if(!s){i.push(r)}}}for(var n=0;n<tasks.length;n++){var r=tasks[n];if(r.quarterStart==r.quarterEnd){continue}if(r.description!=""){var i=t[r.description];if(i!=null){var u=r.quarterStart;for(var o=0;o<i.length;o++){var a=i[o];var f=stoneSum(r,a,u);a.sum+=f;if(a.quarterStart<=r.quarterEnd&&a.quarterStart>=r.quarterStart){u=a.quarterStart}else if(a.quarterStart>r.quarterEnd){u=r.quarterEnd}if(u>=r.quarterEnd){break}}}}renderQuarterInterval(r.quarterStart,r.quarterEnd,r.description,e)}for(var n=0;n<tasks.length;n++){var r=tasks[n];if(r.quarterStart!=r.quarterEnd){continue}var l="";if(r.description!=""){l=r.sum+" "}renderQuarterInterval(r.quarterStart,r.quarterEnd,l+r.description,e)}}function renderSelectedQuarter(){var e=selected_quarter_start;var t=selected_quarter_end;var n=true;renderQuarterInterval(e,t,selected_description,n)}function renderLines(){ctx.strokeStyle=line_style;var e=from_date.getDay();var t=0;var n=visibleDays();var r=visibleWidth()+left_column_width;for(var i=t;i<n;i++){var s=(e+i+6)%7==0;if(s){ctx.lineWidth=line_week_width}else{ctx.lineWidth=line_width}var o=header_height+i*line_height;renderLine(ctx,0,o,r,o)}}function renderDates(){ctx.font=date_font;var e=new Date(from_date.getTime());var t=0;var n=visibleDays();var r=quarterIntervalLines(selected_quarter_start,selected_quarter_end);var i=r[0];var s=r[1];var o=Math.min(i,s);var u=Math.max(i,s)+1;for(var a=t;a<n;a++){if(a>=o&&a<u){ctx.fillStyle=date_font_selected_style}else{ctx.fillStyle=date_font_style}var f=header_height+a*line_height;var l=formatDate(e)+" "+weekdays[e.getDay()];ctx.fillText(l,0,f+line_height+date_offset);e.setDate(e.getDate()+1)}}function renderHourLines(){var e=visibleWidth()/(end_hour-start_hour);var t=header_height+visibleDaysHeight();var n=header_height;var r=0;var i=end_hour-start_hour;for(var s=r;s<i;s++){var o=left_column_width+s*e;renderLine(ctx,o,n,o,t)}}function renderHours(){ctx.font=hour_font;var e=visibleWidth()/(end_hour-start_hour);var t=header_height+visibleDaysHeight();var n=header_height;var r=0;var i=end_hour-start_hour;var s=quarterIntervalHours(selected_quarter_start,selected_quarter_end);var o=s[0];var u=s[1];var a=Math.min(o,u);var f=Math.max(o,u);for(var l=r;l<i;l++){var c=left_column_width+l*e;var h=l+start_hour;if(h>=a&&h<f){ctx.fillStyle=hour_font_selected_style}else{ctx.fillStyle=hour_font_style}ctx.fillText(""+h,c,header_height+hour_offset)}}function renderCalendar(){var e=document.getElementById("calendar");ctx=e.getContext("2d");box_width=e.width;box_height=e.height;ctx.fillStyle=background_style;ctx.fillRect(0,0,box_width,box_height);ctx.fillStyle="black";ctx.fillRect(left_column_width,header_height,visibleWidth(),visibleDaysHeight());ctx.fillStyle=header_fill_style;ctx.fillRect(0,0,visibleWidth()+left_column_width,header_height);ctx.fillStyle=left_column_style;ctx.fillRect(0,header_height,left_column_width,visibleDaysHeight());renderLines();renderHourLines();renderHours();renderDates();renderTasks();renderSelectedQuarter();ctx.fillStyle=title_font_style;ctx.font=title_font;ctx.fillText("o-clock.no (beta)",0,header_height+hour_offset)}function refreshLink(){var e=document.getElementById("linkText");e.value="http://www.o-clock.no/"+createUrlData()}function refreshHours(){var e=document.getElementById("startHour");var t=document.getElementById("endHour");e.value=start_hour;t.value=end_hour}function refreshFromDate(){var e=document.getElementById("fromDate");e.value=formatDate(from_date)}function splitSelected(){var e=[];var t=selected_quarter_start;var n=selected_quarter_end;var r=quarterIntervalFix(t,n);var i=r[0];var s=r[1];var o=quarterToDate(i);var u=quarterToDate(s);var a=quartersStride();var f=o.getHours();var l=u.getHours();if(l<f){l+=24}var c=f*4+Math.floor(o.getMinutes()/15);var h=l*4+Math.floor(u.getMinutes()/15);var p=h-c;var d=(s-h-(i-c))/a+1;for(var v=0;v<d;v++){var m=newTask(i+v*a,i+v*a+p,selected_description);e.push(m)}return e}function makeAddTask(e){var t=document.getElementById(e);t.onkeydown=function(e){e=e||window.event;var t=e.keyCode;if(t==13){if(selected_quarter_end==selected_quarter_start&&selected_description==""){return false}var n=splitSelected();for(var r=0;r<n.length;r++){var i=n[r];if(i.quarterStart==i.quarterEnd&&i.description==""){continue}subtractTask(i.quarterStart,i.quarterEnd)}for(var r=0;r<n.length;r++){if(i.quarterStart==i.quarterEnd&&i.description==""){continue}tasks.push(n[r])}selected_quarter_start=0;selected_quarter_end=0;selected_description="";renderCalendar();refreshLink();return false}else if(t==8){if(selected_description!=""){selected_description=""}else{var n=splitSelected();for(var r=0;r<n.length;r++){var i=n[r];subtractTask(i.quarterStart,i.quarterEnd)}selected_quarter_start=0;selected_quarter_end=0;selected_description=""}renderCalendar();refreshLink();return false}else if(t>=65&&t<=90||t>=48&&t<=57){selected_description+=String.fromCharCode(t);renderCalendar();refreshLink();return false}else if(t==32){selected_description+=" ";renderCalendar();refreshLink();return false}}}function makeSelectQuarterInterval(e){var t=document.getElementById(e);var n=false;t.addEventListener("mousedown",function(e){e=e||window.event;var r=e.pageX-t.offsetLeft;var i=e.pageY-t.offsetTop;var s=posToQuarters(r,i);var o=quarterIntervalHours(s,s+1)[0];var u=quarterIntervalLines(s,s+1)[0];if(o>=end_hour||o<start_hour||u<0||u>=visibleDays()-1){return true}selected_quarter_start=s;selected_quarter_end=s;n=true;selected_description="";renderCalendar();return false},true);t.addEventListener("mousemove",function(e){e=e||window.event;var r=e.pageX-t.offsetLeft;var i=e.pageY-t.offsetTop;if(n){selected_quarter_end=posToQuarters(r,i)}renderCalendar()},true);t.addEventListener("mouseup",function(e){e=e||window.event;var r=e.pageX-t.offsetLeft;var i=e.pageY-t.offsetTop;n=false;renderCalendar()},true)}function makeResizeable(e,t,n,r,i){var s=document.getElementById(e);var o=false;var u=false;var a=0;var f=0;var l=0;var c=0;var h=function(e){var n=e.pageX-s.offsetLeft;var r=e.pageY-s.offsetTop;if(o||u){s.style.cursor="crosshair";return}if(n>s.width-t){s.style.cursor="e-resize"}else if(r>s.height-t){s.style.cursor="s-resize"}else{s.style.cursor="default"}};document.addEventListener("mousemove",function(e){var t=e.pageX-s.offsetLeft;var p=e.pageY-s.offsetTop;if(o){var d=l+(t-a);d=d<n?n:d;s.width=d;i()}if(u){var v=c+(p-f);v=v<r?r:v;s.height=v;i()}h(e)},true);document.addEventListener("mouseup",function(e){if(o||u){o=false;u=false;return false}},true);s.addEventListener("mousedown",function(e){if(o||u){o=false;u=false}e=e||window.event;var n=e.pageX-s.offsetLeft;var r=e.pageY-s.offsetTop;if(n>s.width-t){o=true}else if(r>s.height-t){u=true}a=n;f=r;l=s.width;c=s.height;h(e);if(o||u){return false}},true)}function refreshSelection(){selected_quarter_start=dateInQuarters(from_date)+start_hour*4;selected_quarter_end=selected_quarter_start+8}function onLoad(){var e=document.getElementById("quote");var t=Math.floor(Math.random()*quotes.length);e.textContent='"'+quotes[t%quotes.length]+'"';readTasks();refreshSelection();var n="calendar";makeResizeable(n,line_height,400,200,renderCalendar);makeSelectQuarterInterval(n);makeAddTask(n);refreshHours();refreshFromDate();renderCalendar();refreshLink()}function onSelectFromDate(){var e=document.getElementById("fromDate");from_date=parseDate(e.value);renderCalendar()}function onChangeHour(){var e=document.getElementById("startHour");var t=document.getElementById("endHour");var n=parseInt(e.value);var r=parseInt(t.value);if(n>=0&&n<24&&n<end_hour){start_hour=n}if(r>=0&&r<=24&&r>start_hour){end_hour=r}renderCalendar()}function readTasks(){var e=window.location.search;if(e.length==0||e.indexOf("?data")!=0){return}e=decodeURIComponent(e);var t=document.getElementById("calendar");var n=e.substring(e.indexOf("=")+1,e.indexOf(":"));var r=n.split(",");from_date=quarterToDate(parseInt(r[0]));start_hour=parseInt(r[1]);end_hour=parseInt(r[2]);t.width=parseInt(r[3]);t.height=parseInt(r[4]);var i=r[5];var s=parseInt(i);var o=e.substring(e.indexOf(":")+1);var u=o.split(",");for(var a=0;a<s;a++){var f=parseInt(u[3*a]);var l=parseInt(u[3*a+1]);var c=u[3*a+2];tasks.push(newTask(f,l,c))}}function createUrlData(){var e=document.getElementById("calendar");var t=""+dateInQuarters(from_date)+","+start_hour+","+end_hour+","+e.width+","+e.height+","+ +tasks.length+":";for(var n=0;n<tasks.length;n++){var r=tasks[n];t+=r.quarterStart+",";t+=r.quarterEnd+",";t+=r.description+","}return"?data="+encodeURIComponent(t)}function onLink(){window.location.href=createUrlData()}function onClear(){window.location.href="?"}var quotes=["Today, I am planning to be impulsive.","Waiting for something to happen, is 100% waste of time.","Failing to plan equals planning to fail.","Focus is a matter of deciding what things you're not going to do.","You can click the link 'Manual' if you get stuck.","Tip: Use short descriptions, they are easier to remember.","Heard of milestones? Read about them in the 'Manual'.","<--- There, there 'Manual', it's there!","Select multiple days to insert repeating tasks.","The color of task changes dependent on the description.","Give a milestone same name as tasks to sum hours.","Use 'backspace' to delete.","Insert task by selecting, type description and then 'enter'.","You can expand the view on the right or bottom edge.","The settings under the calendar controls the view.","Click 'Update Url' before you bookmark.","Share with other people, by clicking 'Update Url' and copy the web address."];var background_style="#303030";var header_height=20;var header_fill_style="#333333";var left_column_width=150;var left_column_style="#333333";var right_column_width=80;var line_height=header_height;var line_width=1;var line_week_width=2;var line_style="#888888";var date_font="17px Georgia";var date_font_style="#888888";var date_font_selected_style="#bbbbbb";var date_offset=-3;var hour_font="17px Georgia";var hour_font_style="#888888";var hour_font_selected_style="#bbbbbb";var hour_offset=date_offset;var title_font="17px Georgia";var title_font_style="rgba(80, 147, 161, 1)";var box_width,box_height;var ctx;var now=new Date;var date_format="dd.mm.yy";var start_hour=6;var end_hour=22;var from_date=new Date(now.getFullYear(),now.getMonth(),now.getDate());var weekdays=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var selected_quarter_start=dateInQuarters(from_date)+start_hour*4;var selected_quarter_end=selected_quarter_start+8;var selected_quarter_style="#FFFFFF";var selected_quarter_line_width=3;var selected_description="";var selected_quarter_font="17px Georgia";var default_quarter_font="17px Georgia";var default_quarter_style="rgba(204, 204, 204, 1)";var milestone_style="#cccccc";var selected_milestone_style="#00FFFF";var default_quarter_background="rgba(0, 0, 150, 0.5)";var default_quarter_line_width=2;var description_offset=date_offset;var tasks=[];var colors=["rgba(110, 73, 0, 0.5)","rgba(186, 124, 0, 0.5)","rgba(18, 52, 59, 0.5)","rgba(80, 147, 161, 0.5)","rgba(145, 145, 145, 0.5)","rgba(110, 110, 110, 0.5)"];$(function(){$("#fromDate").datepicker({dateFormat:date_format,onSelect:onSelectFromDate});$("#toDate").datepicker({dateFormat:date_format})});String.prototype.hashCode=function(){var e=0;if(this.length==0)return e;for(var t=0;t<this.length;t++){var n=this.charCodeAt(t);e=(e<<5)-e+n;e%=1<<10}return e}